<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>N3 Tech Academy — Quiz (Criador integrado)</title>
  <style>
    :root{
      --bg: linear-gradient(180deg,#000 0%, #1a0000 100%);
      --card: linear-gradient(180deg, rgba(255,0,0,0.05), rgba(255,255,255,0.02));
      --accent: #e50914; --muted:#b8b8b8; --glass:rgba(255,255,255,0.03);
      --radius:12px; --gap:12px; --ui-font:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      --max-width:1100px;
    }

    /* Typography that scales nicely on all screens */
    html{font-family:var(--ui-font);font-size:clamp(14px, 1.6vw, 16px);}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#fff;-webkit-font-smoothing:antialiased}

    /* container */
    .wrap{max-width:var(--max-width);margin:20px auto;padding:18px}
    .card{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:0 10px 30px rgba(0,0,0,0.7)}

    header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:14px;flex-wrap:wrap}
    .brand h1{font-size:1.15rem;margin:0;color:var(--accent)}
    .brand small{display:block;color:var(--muted);font-size:0.88rem}

    .controls-top{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .input-name{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px 12px;border-radius:10px;color:inherit;min-width:160px}

    .btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}

    /* layout: responsive grid -> switches to stacked columns on small screens */
    .main-grid{display:grid;grid-template-columns:1fr 360px;gap:18px;align-items:start}

    .panel{background:var(--glass);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);min-height:120px}

    .quizzes{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .quiz-card{padding:14px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.01));cursor:pointer;border:1px solid rgba(255,0,0,0.06);display:flex;flex-direction:column;justify-content:space-between}
    .quiz-card h3{margin:0;color:var(--accent);font-size:1rem}
    .small{font-size:0.85rem;color:var(--muted)}
    .badge{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(229,9,20,0.12);color:var(--accent);font-weight:600}

    /* quiz screen */
    #quizScreen{display:none}
    .meta-row{display:flex;gap:10px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
    .pill{background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:999px;color:var(--muted);font-size:0.95rem}
    .progress{width:100%;height:10px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden}
    .progress>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),#ff6b6b)}
    .question{font-size:1.15rem;margin:12px 0}

    /* answers layout adjusts to screen — buttons are large and touch-friendly */
    .answers{display:grid;gap:10px}
    .answer{padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);cursor:pointer;background:transparent;color:white;text-align:left;font-weight:600;display:flex;align-items:center;gap:12px}
    .answer span{font-size:0.95rem;background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px}
    .answer.correct{background:rgba(16,185,129,0.18);border-color:#10b981}
    .answer.wrong{background:rgba(239,68,68,0.18)}

    .controls{display:flex;justify-content:space-between;align-items:center;margin-top:14px;gap:10px;flex-wrap:wrap}

    #result{text-align:center;display:none;padding:18px}

    /* creator UI */
    .creator { display:flex; flex-direction:column; gap:8px; max-height:60vh; overflow:auto }
    .creator input[type="text"], .creator textarea, .creator select { width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:inherit; font-size:0.95rem }
    .question-block { border-radius:10px; padding:10px; background:rgba(0,0,0,0.18); border:1px solid rgba(255,255,255,0.03); }
    .row { display:flex; gap:8px; align-items:center; }
    .opt-row { display:flex; gap:8px; margin-bottom:6px; align-items:center }
    .opt-row input[type="text"] { flex:1 }
    .flex-between { display:flex; justify-content:space-between; align-items:center }

    /* make action buttons more usable on small screens */
    .panel .btn{min-width:0}
    .panel .btn + .btn{margin-left:6px}

    /* responsive tweaks */
    @media (max-width:1200px){ .main-grid{grid-template-columns:1fr 340px} }
    @media (max-width:980px){
      .main-grid{grid-template-columns:1fr;}
      .creator{max-height:40vh}
    }

    @media (max-width:720px){
      .wrap{padding:12px}
      .brand h1{font-size:1rem}
      .input-name{min-width:0;flex:1}
      header{align-items:flex-start}
      .controls-top{width:100%;justify-content:flex-end}
      .quiz-card{padding:12px}
      .answers{gap:8px}
      .answer{padding:12px;font-size:0.95rem}
    }

    /* make answer grid adapt: single column on small, two columns on medium, grid-fit on wide */
    @media (min-width:1100px){ .answers{grid-template-columns:repeat(2,1fr);} }
    @media (max-width:1099px){ .answers{grid-template-columns:repeat(1,1fr);} }

    /* accessibility: larger touch targets for mobile */
    @media (hover:none){ .answer{padding:16px;font-size:1rem} }

    /* ensure the right panel sticks on tall screens but is scrollable on small */
    aside.panel{display:flex;flex-direction:column}
    aside .creator, aside #quizScreen{flex:1;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="application" aria-labelledby="appTitle">
      <header>
        <div class="brand">
          <h1 id="appTitle">Quiz N3 Tech Academy</h1>
          <small>Escolha um quiz, veja o ranking ou crie o seu</small>
        </div>
        <div class="controls-top">
          <input id="playerName" class="input-name" placeholder="Seu nome (opcional)">
          <button id="btnAudioToggle" class="btn secondary" title="Tocar/pausar som ambiente">Som: Off</button>
          <button id="btnClearRanking" class="btn secondary">Limpar ranking</button>
        </div>
      </header>

      <div class="main-grid">
        <!-- LEFT: quiz list -->
        <section id="home" class="panel" aria-labelledby="homeTitle">
          <h2 id="homeTitle" style="color:var(--accent);margin:0 0 8px 0">Quizzes de HTML</h2>
          <p class="small" style="margin:0 0 12px 0">Clique em um quiz para começar</p>

          <div class="quizzes" id="quizList" role="list"></div>

          <div id="ranking" style="margin-top:14px">
            <h3 style="color:var(--accent);margin:0 0 8px 0">Ranking Geral</h3>
            <ol id="rankingList" class="small" aria-live="polite"></ol>
          </div>
        </section>

        <!-- RIGHT: creator + quiz screen -->
        <aside class="panel" style="display:flex;flex-direction:column;gap:12px">
          <!-- Creator -->
          <div id="creatorPanel" class="creator" aria-labelledby="creatorTitle">
            <div class="flex-between">
              <h3 id="creatorTitle" style="color:var(--accent);margin:0">Criar novo quiz</h3>
              <div>
                <button id="btnImport" class="btn secondary" title="Importar JSON">Import</button>
              </div>
            </div>
            <label class="small">Título</label>
            <input id="cqTitle" type="text" placeholder="Título do quiz">
            <label class="small">Descrição</label>
            <input id="cqDesc" type="text" placeholder="Breve descrição">

            <div id="questionsContainer"></div>

            <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap">
              <button id="btnAddQuestion" class="btn secondary">+ Pergunta</button>
              <button id="btnResetCreator" class="btn secondary">Resetar</button>
              <button id="btnSaveQuiz" class="btn">Salvar quiz</button>
            </div>

            <div class="small" style="margin-top:6px;color:var(--muted)">
              Quizzes criados são salvos localmente e aparecem na lista. Você também pode exportar/importar JSON.
            </div>
          </div>

          <!-- Quiz screen (collapsed initially) -->
          <section id="quizScreen" aria-hidden="true" style="display:none">
            <div class="meta-row">
              <div class="pill">Quiz: <strong id="quizTitle">-</strong></div>
              <div class="pill">Pergunta <strong id="currentIdx">1</strong>/<strong id="totalQ">1</strong></div>
              <div class="pill">Pontuação: <strong id="score">0</strong></div>
            </div>

            <div class="question" id="questionText">Questão aparece aqui</div>
            <div class="answers" id="answers" role="list"></div>

            <div class="controls">
              <div style="display:flex;gap:8px">
                <button class="btn secondary" id="btnPrev">Voltar</button>
                <button class="btn secondary" id="btnSkip">Pular</button>
              </div>
              <div>
                <button class="btn" id="btnNext">Próxima</button>
              </div>
            </div>

            <div id="result" style="margin-top:12px;display:none">
              <h4 style="color:var(--accent)">Resultado</h4>
              <div class="score" id="finalScore">0 / 0</div>
              <p id="finalText">Você pode melhorar!</p>
              <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
                <button class="btn" id="btnRestart">Refazer</button>
                <button class="btn secondary" id="btnBackHome">Voltar</button>
              </div>
            </div>
          </section>
        </aside>
      </div>

      <footer style="margin-top:14px;text-align:center;color:var(--muted);font-size:13px">
        © 2025 N3 Desenvolvimento e Soluções — Todos os direitos reservados
      </footer>
    </div>
  </div>

  <script>
    /* -------------------------
       Base quizzes (exemplo)
       ------------------------- */
    const baseQuizzes = [
      { id:'html_intro', title:'Introdução ao HTML', description:'Fundamentos', questions:[
        { q:'O que significa HTML?', a:['HyperText Markup Language','Hyperlinks and Text Markup Language','Home Tool Markup Language'], correct:0 }
      ] }
    ];

    const KEY_CUSTOM = 'custom_quizzes_v1';
    function uid(){ return 'q_' + Math.random().toString(36).slice(2,9); }
    function loadCustom(){ try{ return JSON.parse(localStorage.getItem(KEY_CUSTOM) || '[]'); }catch(e){ return []; } }
    function saveCustom(arr){ localStorage.setItem(KEY_CUSTOM, JSON.stringify(arr)); }
    function getAllQuizzes(){ const custom = loadCustom(); return [...baseQuizzes, ...custom]; }

    const quizList = document.getElementById('quizList');
    const rankingList = document.getElementById('rankingList');
    const btnClearRanking = document.getElementById('btnClearRanking');
    const playerNameInput = document.getElementById('playerName');

    const home = document.getElementById('home');
    const quizScreen = document.getElementById('quizScreen');
    const quizTitleEl = document.getElementById('quizTitle');
    const questionText = document.getElementById('questionText');
    const answersEl = document.getElementById('answers');
    const currentIdx = document.getElementById('currentIdx');
    const totalQ = document.getElementById('totalQ');
    const scoreEl = document.getElementById('score');
    const resultEl = document.getElementById('result');
    const finalScore = document.getElementById('finalScore');
    const finalText = document.getElementById('finalText');
    const btnNext = document.getElementById('btnNext');
    const btnPrev = document.getElementById('btnPrev');
    const btnSkip = document.getElementById('btnSkip');
    const btnRestart = document.getElementById('btnRestart');
    const btnBackHome = document.getElementById('btnBackHome');

    const questionsContainer = document.getElementById('questionsContainer');
    const btnAddQuestion = document.getElementById('btnAddQuestion');
    const btnSaveQuiz = document.getElementById('btnSaveQuiz');
    const btnResetCreator = document.getElementById('btnResetCreator');
    const cqTitle = document.getElementById('cqTitle');
    const cqDesc = document.getElementById('cqDesc');
    const btnImport = document.getElementById('btnImport');
    const btnAudioToggle = document.getElementById('btnAudioToggle');

    let state = { quiz:null, idx:0, score:0, answered:[] };

    /* -------------------------
       UTIL: shuffle with index mapping
       returns {arr: shuffledArray, map: shuffledIndices}
       map[i] = original index of shuffled position i
       inverseMap[originalIndex] = new position (optional)
       ------------------------- */
    function shuffleWithMap(arr){
      // Fisher-Yates while keeping indices
      const indices = arr.map((_,i)=>i);
      for(let i=indices.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [indices[i], indices[j]] = [indices[j], indices[i]];
      }
      const shuffled = indices.map(i=>arr[i]);
      return { arr:shuffled, map:indices };
    }

    /* -------------------------
       AUDIO: WebAudio for ambient + effects (no external files)
       - Ambient: simple looping gentle oscillator (user-initiated)
       - Effects: short beep for correct / wrong
       ------------------------- */
    const AudioEngine = (function(){
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      let ambientOsc = null;
      let ambientGain = null;
      let ambientRunning = false;

      function startAmbient(){
        if(ambientRunning) return;
        // create subtle layered sound using two detuned oscillators
        ambientOsc = ctx.createOscillator();
        const osc2 = ctx.createOscillator();
        ambientGain = ctx.createGain();
        const g2 = ctx.createGain();

        ambientOsc.type = 'sine'; ambientOsc.frequency.value = 220; // low
        osc2.type = 'sine'; osc2.frequency.value = 221.5; // slight detune
        ambientGain.gain.value = 0.0015;
        g2.gain.value = 0.0012;

        ambientOsc.connect(ambientGain);
        osc2.connect(g2);
        ambientGain.connect(ctx.destination);
        g2.connect(ctx.destination);

        ambientOsc.start();
        osc2.start();
        ambientRunning = true;

        // keep references so we can stop both
        ambientOsc._paired = osc2;
        ambientOsc._gainPair = g2;
      }

      function stopAmbient(){
        if(!ambientRunning) return;
        try{
          const osc2 = ambientOsc._paired;
          ambientOsc.stop(); osc2.stop();
        }catch(e){}
        ambientRunning = false;
        ambientOsc = null;
        ambientGain = null;
      }

      function beep(type='ok'){
        // short beep; type 'ok' higher pitch, 'err' lower descending
        const now = ctx.currentTime;
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        if(type==='ok') o.frequency.setValueAtTime(880, now);
        else { o.frequency.setValueAtTime(220, now); o.frequency.exponentialRampToValueAtTime(120, now+0.12); }
        g.gain.setValueAtTime(0.0015, now);
        g.gain.exponentialRampToValueAtTime(0.00001, now+0.18);
        o.connect(g); g.connect(ctx.destination);
        o.start(now); o.stop(now+0.2);
      }

      function resumeIfNeeded(){ if(ctx.state === 'suspended') return ctx.resume(); return Promise.resolve(); }

      return { startAmbient, stopAmbient, beep, resumeIfNeeded, isAmbientRunning: ()=> ambientRunning };
    })();

    /* -------------------------
       RENDER QUIZ LIST
       ensure buttons inside card won't propagate to card click
       ------------------------- */
    function renderQuizList(){
      const all = getAllQuizzes();
      quizList.innerHTML = '';
      all.forEach(q=>{
        const isCustom = !!(loadCustom().find(x=>x.id === q.id));
        const div = document.createElement('div');
        div.className = 'quiz-card';
        div.tabIndex = 0;
        div.innerHTML = `<div>
            <h3>${escape(q.title)}</h3>
            <div class="small" style="color:var(--muted)">${escape(q.description || '')}</div>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center;justify-content:space-between">
            <span class="badge">${q.questions.length} perguntas</span>
            <div class="quiz-actions"></div>
          </div>`;
        // append first, then create action buttons
        quizList.appendChild(div);
        const actions = div.querySelector('.quiz-actions');
        // Edit/Delete for custom
        if(isCustom){
          const editBtn = document.createElement('button');
          editBtn.className = 'btn secondary';
          editBtn.textContent = 'Editar';
          editBtn.dataset.edit = q.id;
          editBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); openEditor(q.id); });
          const delBtn = document.createElement('button');
          delBtn.className = 'btn secondary';
          delBtn.textContent = 'Excluir';
          delBtn.dataset.del = q.id;
          delBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); deleteCustomQuiz(q.id); });
          actions.appendChild(editBtn);
          actions.appendChild(delBtn);
        }

        // clicking the card starts quiz (but not if clicked on internal buttons)
        div.addEventListener('click', (e)=>{ startQuiz(q.id); });
        div.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' ') startQuiz(q.id); });
      });
    }

    /* -------------------------
       START QUIZ
       - clone quiz
       - shuffle options per question (store map on question)
       ------------------------- */
    function startQuiz(id){
      const all = getAllQuizzes();
      const q = all.find(x=>x.id === id);
      if(!q) return alert('Quiz não encontrado');
      // clone to avoid mutating stored quizzes
      const cloned = deepClone(q);
      // For each question, shuffle options and keep mapping:
      cloned.questions.forEach((qq)=>{
        const { arr, map } = shuffleWithMap(qq.a);
        qq._shuffled = arr;       // reordered options
        qq._map = map;            // map[newIndex] = originalIndex
        // we keep original correct index in qq.correct (original)
      });
      state.quiz = cloned;
      state.idx = 0; state.score = 0; state.answered = Array(cloned.questions.length).fill(null);
      home.style.display = 'none';
      quizScreen.style.display = 'block';
      quizScreen.setAttribute('aria-hidden','false');
      resultEl.style.display = 'none';
      quizTitleEl.textContent = q.title;
      totalQ.textContent = q.questions.length;
      renderQuestion();
      // scroll quizScreen into view on small devices
      setTimeout(()=> quizScreen.scrollIntoView({behavior:'smooth', block:'start'}),100);
    }

    /* -------------------------
       RENDER QUESTION
       uses question._shuffled and question._map
       state.answered stores original selected index (or null)
       ------------------------- */
    function renderQuestion(){
      const Q = state.quiz.questions[state.idx];
      currentIdx.textContent = state.idx + 1;
      scoreEl.textContent = state.score;
      questionText.textContent = Q.q;
      answersEl.innerHTML = '';
      const opts = Q._shuffled || Q.a;
      opts.forEach((opt, i)=>{
        const btn = document.createElement('button');
        btn.className = 'answer'; btn.type = 'button';
        btn.innerHTML = `<span>${i+1}</span> <div style="flex:1">${escape(opt)}</div>`;
        const originalIndex = (Q._map && Q._map[i] !== undefined) ? Q._map[i] : i;
        const answeredOriginal = state.answered[state.idx];
        if (answeredOriginal != null) {
          // already answered: show correct/wrong based on original indices
          if (originalIndex === Q.correct) btn.classList.add('correct');
          if (originalIndex === answeredOriginal && originalIndex !== Q.correct) btn.classList.add('wrong');
          btn.disabled = true;
        } else {
          btn.addEventListener('click', ()=> selectAnswer(originalIndex));
        }
        answersEl.appendChild(btn);
      });
      btnNext.textContent = (state.idx === state.quiz.questions.length - 1) ? 'Finalizar' : 'Próxima';
    }

    function selectAnswer(originalIndex){
      if (state.answered[state.idx] != null) return;
      const Q = state.quiz.questions[state.idx];
      state.answered[state.idx] = originalIndex;
      if (originalIndex === Q.correct) {
        state.score++;
        AudioEngine.beep('ok');
      } else {
        AudioEngine.beep('err');
      }
      // reveal feedback
      [...answersEl.children].forEach((el, idx)=>{
        el.disabled = true;
        const q = state.quiz.questions[state.idx];
        // compute original index for this displayed button
        const displayedOriginal = (q._map && q._map[idx] !== undefined) ? q._map[idx] : idx;
        if(displayedOriginal === q.correct) el.classList.add('correct');
        if(displayedOriginal === state.answered[state.idx] && displayedOriginal !== q.correct) el.classList.add('wrong');
      });
      scoreEl.textContent = state.score;
      document.addEventListener('keydown', onEnterNext, { once:true });
    }

    function onEnterNext(e){ if(e.key === 'Enter' && state.answered[state.idx] != null) next(); }
    function next(){ if (state.idx === state.quiz.questions.length - 1) { showResult(); return; } state.idx++; renderQuestion(); }
    function prev(){ if(state.idx>0){ state.idx--; renderQuestion(); } }
    function skip(){ if(state.idx === state.quiz.questions.length - 1){ showResult(); return; } state.idx++; renderQuestion(); }

    function showResult(){
      answersEl.style.display = 'none';
      resultEl.style.display = 'block';
      const total = state.quiz.questions.length;
      finalScore.textContent = `${state.score} / ${total}`;
      const pct = Math.round((state.score/total)*100);
      finalText.textContent = pct >= 80 ? `Excelente — ${pct}%` : pct >= 50 ? `Bom — ${pct}%` : `Precisa melhorar — ${pct}%`;
      saveScore(state.quiz.id, state.quiz.title, pct);
      loadRanking();
      // bring result into view on mobile
      setTimeout(()=> resultEl.scrollIntoView({behavior:'smooth', block:'center'}),80);
    }

    function backHome(){ home.style.display = ''; quizScreen.style.display = 'none'; answersEl.style.display = ''; resultEl.style.display = 'none'; }

    function saveScore(quizId, quizTitle, pct){
      const name = (playerNameInput.value || 'Anônimo').trim();
      let scores = JSON.parse(localStorage.getItem('quizScores') || '[]');
      scores.push({ quizId, quiz: quizTitle, name, score: pct, date: new Date().toLocaleString() });
      const grouped = {};
      scores.forEach(s => {
        const key = `${s.quizId}::${s.name}`;
        if(!grouped[key] || grouped[key].score < s.score) grouped[key] = s;
      });
      const deduped = Object.values(grouped).sort((a,b)=> b.score - a.score).slice(0,20);
      localStorage.setItem('quizScores', JSON.stringify(deduped));
    }
    function loadRanking(){
      let scores = JSON.parse(localStorage.getItem('quizScores') || '[]');
      if(!scores.length) { rankingList.innerHTML = '<li>Nenhum resultado ainda</li>'; return; }
      rankingList.innerHTML = scores.map(s => `<li><strong>${escape(s.quiz)}</strong> — ${s.score}% <em>(${escape(s.name)})</em> <small style="color:var(--muted)"> — ${escape(s.date)}</small></li>`).join('');
    }
    btnClearRanking.addEventListener('click', ()=>{ if(confirm('Deseja limpar todo o ranking local?')){ localStorage.removeItem('quizScores'); loadRanking(); } });

    /* -------------------------
       BUILDER (creator)
       largely unchanged — rendering wires event listeners after DOM creation
       ------------------------- */
    let builder = [];
    function createEmptyQuestion(){ return { q:'', a:['',''], correct:0 }; }

    function renderBuilder(){
      questionsContainer.innerHTML = '';
      builder.forEach((qb, qi)=>{
        const block = document.createElement('div');
        block.className = 'question-block';
        block.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <strong>Pergunta ${qi+1}</strong>
            <div>
              <button class="btn secondary" data-moveup="${qi}">↑</button>
              <button class="btn secondary" data-movedown="${qi}">↓</button>
              <button class="btn secondary" data-remove="${qi}">Remover</button>
            </div>
          </div>
          <input class="q-input" data-qidx="${qi}" type="text" placeholder="Texto da pergunta" value="${escapeAttr(qb.q)}">
          <div class="opts" style="margin-top:8px"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn secondary" data-addopt="${qi}">+ Opção</button>
            <label class="small" style="display:flex;align-items:center;gap:8px;margin-left:auto">Correta:
              <select class="correct-select" data-qidx="${qi}">${qb.a.map((_,i)=>`<option value="${i}" ${i===qb.correct? 'selected':''}>Opção ${i+1}</option>`).join('')}</select>
            </label>
          </div>
        `;
        questionsContainer.appendChild(block);
        const optsEl = block.querySelector('.opts');
        qb.a.forEach((opt, oi)=>{
          const optRow = document.createElement('div');
          optRow.className = 'opt-row';
          optRow.innerHTML = `<input data-qidx="${qi}" data-oidx="${oi}" type="text" placeholder="Texto da opção" value="${escapeAttr(opt)}">
                              <button class="btn secondary" data-remopt="${qi}|${oi}">Rem</button>`;
          optsEl.appendChild(optRow);
        });
      });

      // event wiring
      questionsContainer.querySelectorAll('[data-addopt]').forEach(b=> b.addEventListener('click', ()=> { const qi = Number(b.dataset.addopt); builder[qi].a.push(''); renderBuilder(); }));
      questionsContainer.querySelectorAll('[data-remove]').forEach(b=> b.addEventListener('click', ()=> { const qi = Number(b.dataset.remove); builder.splice(qi,1); renderBuilder(); }));
      questionsContainer.querySelectorAll('[data-moveup]').forEach(b=> b.addEventListener('click', ()=> { const qi = Number(b.dataset.moveup); if(qi>0){ [builder[qi-1],builder[qi]] = [builder[qi],builder[qi-1]]; renderBuilder(); } }));
      questionsContainer.querySelectorAll('[data-movedown]').forEach(b=> b.addEventListener('click', ()=> { const qi = Number(b.dataset.movedown); if(qi < builder.length-1){ [builder[qi+1],builder[qi]] = [builder[qi],builder[qi+1]]; renderBuilder(); } }));
      questionsContainer.querySelectorAll('[data-remopt]').forEach(b=> b.addEventListener('click', ()=>{ const [qi,oi] = b.dataset.remopt.split('|').map(Number); if(builder[qi].a.length <= 2) return alert('Mínimo 2 opções'); builder[qi].a.splice(oi,1); if(builder[qi].correct >= builder[qi].a.length) builder[qi].correct = 0; renderBuilder(); }));

      questionsContainer.querySelectorAll('.q-input').forEach(inp => inp.addEventListener('input', (e)=> { const qi = Number(e.target.dataset.qidx); builder[qi].q = e.target.value; }));
      questionsContainer.querySelectorAll('.opt-row input').forEach(inp => inp.addEventListener('input', (e)=> { const qi = Number(e.target.dataset.qidx); const oi = Number(e.target.dataset.oidx); builder[qi].a[oi] = e.target.value; }));
      questionsContainer.querySelectorAll('.correct-select').forEach(sel => sel.addEventListener('change', (e)=> { const qi = Number(e.target.dataset.qidx); builder[qi].correct = Number(e.target.value); }));
    }

    btnAddQuestion.addEventListener('click', ()=> { builder.push(createEmptyQuestion()); renderBuilder(); });
    btnResetCreator.addEventListener('click', ()=> { if(confirm('Resetar o formulário de criação?')){ builder = []; cqTitle.value=''; cqDesc.value=''; renderBuilder(); } });

    btnSaveQuiz.addEventListener('click', ()=>{ 
      const title = (cqTitle.value || '').trim();
      if(!title) return alert('Informe um título');
      if(builder.length < 1) return alert('Adicione pelo menos 1 pergunta');
      for(let i=0;i<builder.length;i++){
        const b = builder[i];
        if(!b.q.trim()) return alert(`Pergunta ${i+1} está vazia`);
        if(b.a.length < 2) return alert(`Pergunta ${i+1} precisa de ao menos 2 opções`);
        for(let j=0;j<b.a.length;j++) if(!b.a[j].trim()) return alert(`Opção ${j+1} da pergunta ${i+1} está vazia`);
      }
      const newQuiz = {
        id: uid(),
        title,
        description: (cqDesc.value||'').trim(),
        questions: builder.map(b => ({ q: b.q.trim(), a: b.a.map(x=>x.trim()), correct: Number(b.correct) } ))
      };
      const custom = loadCustom(); custom.push(newQuiz); saveCustom(custom);
      builder = []; cqTitle.value=''; cqDesc.value=''; renderBuilder(); renderQuizList(); alert('Quiz salvo localmente! Agora aparece na lista.');
    });

    btnImport.addEventListener('click', async ()=>{
      const json = prompt('Cole aqui o JSON do quiz para importar (objeto com title, description, questions[])');
      if(!json) return;
      try{
        const obj = JSON.parse(json);
        if(!obj.title || !Array.isArray(obj.questions)) return alert('JSON inválido');
        const q = { id: uid(), title: obj.title, description: obj.description||'', questions: obj.questions.map(x=>({ q:x.q, a:x.a, correct: Number(x.correct)||0 })) };
        const custom = loadCustom(); custom.push(q); saveCustom(custom); renderQuizList(); alert('Quiz importado com sucesso');
      }catch(e){ alert('JSON inválido'); }
    });

    function deleteCustomQuiz(id){ if(!confirm('Excluir quiz criado localmente? Esta ação não pode ser desfeita.')) return; let custom = loadCustom(); custom = custom.filter(x=> x.id !== id); saveCustom(custom); renderQuizList(); }

    function openEditor(id){ const custom = loadCustom(); const q = custom.find(x=> x.id === id); if(!q) return alert('Quiz não encontrado'); if(!confirm('Carregar quiz no editor para edição? O quiz original será removido e substituído ao salvar.')) return; let rest = custom.filter(x=> x.id !== id); saveCustom(rest); cqTitle.value = q.title; cqDesc.value = q.description || ''; builder = q.questions.map(qq => ({ q: qq.q, a: qq.a.slice(), correct: Number(qq.correct) || 0 })); renderBuilder(); renderQuizList(); window.scrollTo({ top: 0, behavior: 'smooth' }); }

    function deepClone(o){ return JSON.parse(JSON.stringify(o)); }
    function escape(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function escapeAttr(s){ return String(s||'').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }

    /* -------------------------
       INIT and keyboard support
       - numeric keys will pick answers considering visible buttons
       ------------------------- */
    function init(){
      renderQuizList(); loadRanking(); renderBuilder();
      btnNext.addEventListener('click', next);
      btnPrev.addEventListener('click', prev);
      btnSkip.addEventListener('click', skip);
      btnRestart.addEventListener('click', ()=> {
        if(!state.quiz) return;
        state.idx=0; state.score=0; state.answered = Array(state.quiz.questions.length).fill(null);
        answersEl.style.display=''; resultEl.style.display='none'; renderQuestion();
      });
      btnBackHome.addEventListener('click', backHome);

      window.addEventListener('keydown', (e)=>{
        if (quizScreen.style.display !== 'block') return;
        const activeAnswers = [...answersEl.children].filter(c => !c.disabled);
        if (!activeAnswers.length) return;
        if (/^[1-9]$/.test(e.key)){
          const n = Number(e.key)-1;
          if(n >=0 && n < activeAnswers.length) activeAnswers[n].click();
        }
        if (e.key === 'Enter'){ if(state.answered[state.idx] != null) next(); }
      });

      // audio toggle: ensure AudioContext resumes on first user gesture if needed
      btnAudioToggle.addEventListener('click', async ()=>{
        await AudioEngine.resumeIfNeeded();
        if(AudioEngine.isAmbientRunning()){
          AudioEngine.stopAmbient();
          btnAudioToggle.textContent = 'Som: Off';
        } else {
          AudioEngine.startAmbient();
          btnAudioToggle.textContent = 'Som: On';
        }
      });

      // Accessibility: ensure buttons created dynamically are tabbable
      // (already created as buttons)
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
